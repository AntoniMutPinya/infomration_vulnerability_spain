
# This R script is designed to perform a Principal Component Analysis (PCA) with 
# four components using various sociodemographic variables from the ecf_2016 dataset. 
# The PCA results will be used as control variables in subsequent regression models. 
# The script also includes plotting and analysis of factor loadings, as well as 
# the implementation of a regression model (logistic regression) to examine 
# relationships between dependent and independent variables while adjusting for PCA components.

# Step 1: Data Preparation
# Create a data frame (BE) using the ecf_2016 dataset, selecting specific questions (Q1 to Q12).
# Negative values are replaced with 0 for all selected variables.
BE <- data.frame(
  Q1 = ifelse(ecf_2016$d0101 > 0, ecf_2016$d0101, 0),
  Q2 = ifelse(ecf_2016$d0102 > 0, ecf_2016$d0102, 0),
  Q3 = ifelse(ecf_2016$d0103 > 0, ecf_2016$d0103, 0),
  Q4 = ifelse(ecf_2016$d0104 > 0, ecf_2016$d0104, 0),
  Q5 = ifelse(ecf_2016$d0105 > 0, ecf_2016$d0105, 0),
  Q6 = ifelse(ecf_2016$d0106 > 0, ecf_2016$d0106, 0),
  Q7 = ifelse(ecf_2016$d0107 > 0, ecf_2016$d0107, 0),
  Q8 = ifelse(ecf_2016$d0108 > 0, ecf_2016$d0108, 0),
  Q9 = ifelse(ecf_2016$d0109 > 0, ecf_2016$d0109, 0),
  Q10 = ifelse(ecf_2016$d0110 > 0, ecf_2016$d0110, 0),
  Q11 = ifelse(ecf_2016$d0111 > 0, ecf_2016$d0111, 0),
  Q12 = ifelse(ecf_2016$d0112 > 0, ecf_2016$d0112, 0)
)

# Step 2: PCA Preparation
# Compute the polychoric correlation matrix.
mat_cor <- hetcor(BE)$correlations

# Perform Bartlettâ€™s test to check the sphericity of the correlation matrix.
bartlett_test <- cortest.bartlett(mat_cor)

# Step 3: Factor Analysis (PCA)
# Perform PCA with 4 components using factor analysis (minres method).
fa_FL <- fa(BE, nfactors = 4, rotate = 'none', fm = 'pa', max.iter = 1, scores = "Bartlett")
df_Inst <- as.data.frame(fa_FL$scores)  # Save the factor scores

# Step 4: Create a DataFrame with Scaled Factor Scores
# Apply Min-Max scaling to factor scores.
min_max_scale <- function(x) {
  min_range <- 0
  max_range <- 1
  min_x <- min(x)
  max_x <- max(x)
  min_range + ((x - min_x) / (max_x - min_x)) * (max_range - min_range)
}

I1 <- min_max_scale(df_Inst$PA1)
I2 <- min_max_scale(df_Inst$PA2)
I3 <- min_max_scale(df_Inst$PA3)
I4 <- min_max_scale(df_Inst$PA4)

# Clean up by removing temporary variables.
rm(df_Inst, fa_FL, mat_cor, df_Inst, BE)

