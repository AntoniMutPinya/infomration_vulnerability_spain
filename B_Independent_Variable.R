
# This R script is designed to calculate the Information Vulnerability Index (IV), 
# which serves as an independent variable for further analysis. 
# The script processes data related to financial literacy, basic numeracy, 
# literacy skills, and the ability to read graphs, then uses Item Response Theory (IRT) 
# models to estimate a numerical index. This IV represents the vulnerability level 
# of individuals based on their responses to these questions. 
# Additionally, Min-Max scaling and normalization are applied to ensure the 
# values fall within a standard range, making the IV suitable for various analyses.


# Min-Max scaling function for variables.
min_max_scale <- function(x) {
  min_range <- 0
  max_range <- 1
  min_x <- min(x)
  max_x <- max(x)
  min_range + ((x - min_x) / (max_x - min_x)) * (max_range - min_range)
}


create_df_Answers <- function(ecf_2016) {
  
  # Create the data frame using conditional logic for Financial Literacy, 
  # Basic Numeracy, and Reading Graphs.
  df_Answers <- data.frame(
    
    # Financial Literacy
    FL1 = ifelse(ecf_2016$e0600 == 3, 1, 0),
    FL2 = ifelse(ecf_2016$e0700 == 0, 1, 0),
    FL3 = ifelse(ecf_2016$e0800 == 102, 1, 0),
    FL4 = ifelse(ecf_2016$e0900 == 1, 1, 0),
    FL5 = ifelse(ecf_2016$e1001 == 1, 1, 0),
    FL6 = ifelse(ecf_2016$e1002 == 1, 1, 0),
    FL7 = ifelse(ecf_2016$e1003 == 1, 1, 0),
    FL8 = ifelse(ecf_2016$e1200 == 1, 1, 0),

    # Basic Numeracy and Literacy
    NL1 = ifelse(ecf_2016$e0500 == 200, 1, 0),
    NL2 = ifelse(ecf_2016$e1101 == 1, 1, 0),
    NL3 = ifelse(ecf_2016$e1102 == 3, 1, 0),
    NL4 = ifelse(ecf_2016$e0401 == 3, 1, 0),
    NL5 = ifelse(ecf_2016$e0402 == 18, 1, 0),
    NL6 = ifelse(ecf_2016$e0403 == 2, 1, 0),
    NL7 = ifelse(ecf_2016$e0300 == 5, 1, 0),

    # Reading Graphs
    e0200a = ifelse(ecf_2016$e0200a == 1, 0.2, 0),
    e0200b = ifelse(ecf_2016$e0200b == 1, 0.2, 0),
    e0200c = ifelse(ecf_2016$e0200c == 0, 0.2, 0),
    e0200d = ifelse(ecf_2016$e0200d == 0, 0.2, 0),
    e0200e = ifelse(ecf_2016$e0200e == 0, 0.2, 0)

  )
  
  # Summation for NL variables (graph reading)
  df_Answers$NL8 <- df_Answers$e0200a + df_Answers$e0200b + df_Answers$e0200c + 
    df_Answers$e0200d + df_Answers$e0200e
  
  # Remove duplicated variables
  df_Answers <- df_Answers[, !colnames(df_Answers) %in% c("e0200a", 
                                                          "e0200b", 
                                                          "e0200c", 
                                                          "e0200d", 
                                                          "e0200e")]
  
  return(df_Answers)
}


# Function to fit a 3PL model and calculate the numerical index
create_index <- function(df_Answers, unimodel = 'F1 = 1-16') {
  
  # Select columns that start with "FL" from df_Answers
  columns_FL <- grep("^FL|NL", names(df_Answers), value = TRUE)
  
  df_FL <- df_Answers[, columns_FL]
  
  # Fit the 2PL model using the mirt function
  fit2PL <- mirt(data = df_FL, 
                 model = unimodel,  
                 itemtype = "2PL", 
                 verbose = FALSE)
  
  # Get the estimated scores (theta)
  IV <- fscores(fit2PL)
  
  return(IV)
}


# Usage
df_Answers <- create_df_Answers(ecf_2016)
IV <- min_max_scale(create_index(df_Answers))
IV <- orderNorm(IV)
IV <- min_max_scale(IV$x.t)



