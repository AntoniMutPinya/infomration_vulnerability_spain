

### DATA & PACKAGES

source('A_Data_&_Packages.R')

################################################################################
### INDEPENDENT VARIABLE (X)
################################################################################

# Calculate the Information Vulnerability Index (IV) using data related to financial literacy, basic numeracy,
# and graph reading skills. This index is estimated using an Item Response Theory (IRT) model.

# Min-Max scaling function for normalization
min_max_scale <- function(x) {
  min_range <- 0
  max_range <- 1
  min_x <- min(x)
  max_x <- max(x)
  min_range + ((x - min_x) / (max_x - min_x)) * (max_range - min_range)
}

# Function to create the answers dataframe used for IRT-based index calculation
create_df_Answers <- function(ecf_2016) {
  
  # Dataframe creation using conditional logic for Financial Literacy (FL), Numeracy (NL), and Graph Reading
  df_Answers <- data.frame(
    
    # Financial Literacy questions
    FL1 = ifelse(ecf_2016$e0600 == 3, 1, 0),
    FL2 = ifelse(ecf_2016$e0700 == 0, 1, 0),
    FL3 = ifelse(ecf_2016$e0800 == 102, 1, 0),
    FL4 = ifelse(ecf_2016$e0900 == 1, 1, 0),
    FL5 = ifelse(ecf_2016$e1001 == 1, 1, 0),
    FL6 = ifelse(ecf_2016$e1002 == 1, 1, 0),
    FL7 = ifelse(ecf_2016$e1003 == 1, 1, 0),
    FL8 = ifelse(ecf_2016$e1200 == 1, 1, 0),
    
    # Basic Numeracy and Literacy
    NL1 = ifelse(ecf_2016$e0500 == 200, 1, 0),
    NL2 = ifelse(ecf_2016$e1101 == 1, 1, 0),
    NL3 = ifelse(ecf_2016$e1102 == 3, 1, 0),
    NL4 = ifelse(ecf_2016$e0401 == 3, 1, 0),
    NL5 = ifelse(ecf_2016$e0402 == 18, 1, 0),
    NL6 = ifelse(ecf_2016$e0403 == 2, 1, 0),
    NL7 = ifelse(ecf_2016$e0300 == 5, 1, 0),
    
    # Reading Graphs (each correct answer contributes to the score)
    e0200a = ifelse(ecf_2016$e0200a == 1, 0.2, 0),
    e0200b = ifelse(ecf_2016$e0200b == 1, 0.2, 0),
    e0200c = ifelse(ecf_2016$e0200c == 0, 0.2, 0),
    e0200d = ifelse(ecf_2016$e0200d == 0, 0.2, 0),
    e0200e = ifelse(ecf_2016$e0200e == 0, 0.2, 0),
    
    # Filter variable
    filter = ecf_2016$b0600
  )
  
  # Sum graph reading questions to create an overall score
  df_Answers$NL8 <- df_Answers$e0200a + df_Answers$e0200b + df_Answers$e0200c + 
    df_Answers$e0200d + df_Answers$e0200e
  
  # Remove unnecessary columns
  df_Answers <- df_Answers[, !colnames(df_Answers) %in% c("e0200a", "e0200b", "e0200c", "e0200d", "e0200e")]
  
  # Filter out invalid data (-98 values)
  df_Answers <- df_Answers[df_Answers$filter != -98, ]
  return(df_Answers)
}

# Function to fit a 2PL model and calculate the Information Vulnerability Index
create_index <- function(df_Answers, unimodel = 'F1 = 1-16') {
  
  # Select financial literacy and numeracy columns
  columns_FL <- grep("^FL|NL", names(df_Answers), value = TRUE)
  df_FL <- df_Answers[, columns_FL]
  
  # Fit the 2PL IRT model
  fit2PL <- mirt(data = df_FL, model = unimodel, itemtype = "2PL", verbose = FALSE)
  
  # Extract the factor scores (theta) as the index
  IV <- fscores(fit2PL)
  
  return(IV)
}

# Generate the IV index
df_Answers <- create_df_Answers(ecf_2016)
IV <- min_max_scale(create_index(df_Answers))
IV <- as.data.frame(IV)
IV <- IV$F1

# Clean up variables
rm(df_Answers, create_df_Answers, create_index)

################################################################################
### DEPENDENT VARIABLE (Y)
################################################################################

# Calculate DV5: Handle missing values in b0700b by replacing negative values with NaN

df_DV <- data.frame(
  
  DV6 = ifelse(ecf_2016$b0901 <= 0, 0, ecf_2016$b0901), 
  DV7 = ifelse(ecf_2016$b0902 <= 0, 0, ecf_2016$b0902),
  DV8 = ifelse(ecf_2016$b0903 <= 0, 0, ecf_2016$b0903),
  filter = ifelse(ecf_2016$b0600 == -98, NA, ecf_2016$b0600)  
)

df_DV <- na.omit(df_DV)

DV6 <- df_DV$DV6
DV7 <- df_DV$DV7
DV8 <- df_DV$DV8

rm(df_DV)

################################################################################
### CONTROL VARIABLES (PCA)
################################################################################

# Select specific columns from the 'ecf_2016' dataset to create the 'df' dataframe
df <- ecf_2016 %>% select(a04, a0000, a1100, a0900b, a0900c, a0900d, 
                          a1500, j1300)

# Age: Replace -98 values (invalid data) with NA, otherwise keep the original value from 'a04'
df$Age <- ifelse(df$a04 == -98, NA, df$a04)

# Educational Background: Replace negative values (invalid data) with NA, otherwise keep the original value from 'a1100'
df$`Educational_Background` <- ifelse(df$a1100 < 0, NA, df$a1100)

# Gender: Directly assign the values from 'a0000' to the 'Gender' column
df$Gender <- df$a0000

# Professional Status: Replace negative values (invalid data) with NA, otherwise keep the original value from 'a1500'
df$`Professional_Status` <- ifelse(df$a1500 < 0, NA, df$a1500)

# Family Income: Replace negative values (invalid data) with NA, otherwise keep the original value from 'j1300'
df$`Family_Income` <- ifelse(df$j1300 < 0, NA, df$j1300)

# Family Unit (Living Situation)
# 'Living with partner': Set to 1 if 'a0900b' > 0, otherwise 0
df$`Living_with_partner` <- ifelse(df$a0900b <= 0, 0 , 1)

# 'Living with children (<18)': Set to 1 if 'a0900c' > 0, otherwise 0
df$`Living_with_children_under_18` <- ifelse(df$a0900c <= 0, 0 , 1)

# 'Living with children (+18)': Set to 1 if 'a0900d' > 0, otherwise 0
df$`Living_with_children_over_18` <- ifelse(df$a0900d <= 0, 0 , 1)

# Loop through each row of the dataframe to determine family situation
for(i in 1:nrow(df)){
  # If not living with a partner and no children, set 'Family Situation' to 0 (No family)
  if(df$`Living_with_partner`[i] == 0 && df$`Living_with_children_under_18`[i] == 0 && 
     df$`Living_with_children_over_18`[i] == 0){
    df$`Family_Situation`[i] <- 0
  }
  # If living with children (under or over 18), set 'Family Situation' to 1
  else if(df$`Living_with_children_under_18`[i] == 1 | df$`Living_with_children_over_18`[i] == 1){
    df$`Family_Situation`[i] <- 1
  }
  # Otherwise, set 'Family Situation' to 2 (Living with partner but no children)
  else{
    df$`Family_Situation`[i] <- 2
  }
}

# Create a new dataframe (df_CV) with the selected control variables (sociodemographic data)
df_CV <- df %>% select(Age, `Educational_Background`, Gender, 
                       `Professional_Status`, `Family_Income`, 
                       `Family_Situation`)

# Add the filter column to df_CV and filter out invalid data
df_CV$filter <- ecf_2016$b0600
df_CV <- df_CV[df_CV$filter != -98, ]

# Clean up memory by removing unnecessary variables
rm(df)


################################################################################
### REGRESSION (IV Models)
################################################################################

# Models 6 - 7 - 8
data <- data.frame(
  Y_1 = DV6,
  Y_2 = DV7,
  Y_3 = DV8,
  X = IV,
  C_1 = df_CV$Age,
  C_2 = df_CV$Educational_Background,
  C_3 = df_CV$Professional_Status,
  C_4 = df_CV$Family_Income,
  C_5 = df_CV$Family_Situation
)

fitY1.LX <- glm(Y_1 ~ X + C_1 + C_2 + C_3 + C_4 + C_5, family = "binomial", data = data)
fitY2.LX <- glm(Y_1 ~ X + C_1 + C_2 + C_3 + C_4 + C_5, family = "binomial", data = data)
fitY3.LX <- glm(Y_1 ~ X + C_1 + C_2 + C_3 + C_4 + C_5, family = "binomial", data = data)

#summary(fitY1.LX)
#summary(fitY2.LX)
#summary(fitY3.LX)

# Call:
#  glm(formula = Y_1 ~ X + C_1 + C_2 + C_3 + C_4 + C_5, family = "binomial", data = data)
#
# Deviance Residuals: 
#  Min       1Q   Median       3Q      Max  
# -1.1726  -1.0279  -0.9612   1.3195   1.5215  
#
# Coefficients:
# Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.8422970  0.1994600  -4.223 2.41e-05 ***
#  X           -0.1087398  0.2252735  -0.483   0.6293    
#  C_1          0.0065391  0.0029101   2.247   0.0246 *  
#  C_2         -0.0116698  0.0203512  -0.573   0.5664    
#  C_3          0.0006225  0.0054418   0.114   0.9089    
#  C_4          0.0832376  0.0327686   2.540   0.0111 *  
#  C_5          0.0027985  0.0568527   0.049   0.9607    
#  ---
#  Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


# Call:
#  glm(formula = Y_1 ~ X + C_1 + C_2 + C_3 + C_4 + C_5, family = "binomial", data = data)
#
# Deviance Residuals: 
#  Min       1Q   Median       3Q      Max  
# -1.1726  -1.0279  -0.9612   1.3195   1.5215  
#
# Coefficients:
#  Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.8422970  0.1994600  -4.223 2.41e-05 ***
#  X           -0.1087398  0.2252735  -0.483   0.6293    
#  C_1          0.0065391  0.0029101   2.247   0.0246 *  
#  C_2         -0.0116698  0.0203512  -0.573   0.5664    
#  C_3          0.0006225  0.0054418   0.114   0.9089    
#  C_4          0.0832376  0.0327686   2.540   0.0111 *  
#  C_5          0.0027985  0.0568527   0.049   0.9607    
#  ---
#  Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


# Call:
#  glm(formula = Y_1 ~ X + C_1 + C_2 + C_3 + C_4 + C_5, family = "binomial", data = data)
#
#  Deviance Residuals: 
#  Min       1Q   Median       3Q      Max  
# -1.1726  -1.0279  -0.9612   1.3195   1.5215  
#
# Coefficients:
# Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.8422970  0.1994600  -4.223 2.41e-05 ***
#  X           -0.1087398  0.2252735  -0.483   0.6293    
#  C_1          0.0065391  0.0029101   2.247   0.0246 *  
#  C_2         -0.0116698  0.0203512  -0.573   0.5664    
#  C_3          0.0006225  0.0054418   0.114   0.9089    
#  C_4          0.0832376  0.0327686   2.540   0.0111 *  
#  C_5          0.0027985  0.0568527   0.049   0.9607    
#  ---
#  Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
